<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Appers Gold v3 (Fixed)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        dark: { bg: '#0f172a', card: '#1e293b', border: '#334155', text: '#f1f5f9' },
                        gold: '#fbbf24',
                        primary: '#3b82f6'
                    },
                    animation: {
                        'pop': 'pop 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275)',
                        'float': 'float 3s ease-in-out infinite',
                        'shimmer': 'shimmer 3s ease infinite'
                    },
                    keyframes: {
                        pop: { '0%': { transform: 'scale(0.9)', opacity: 0 }, '100%': { transform: 'scale(1)', opacity: 1 } },
                        float: { '0%, 100%': { transform: 'translateY(0)' }, '50%': { transform: 'translateY(-5px)' } },
                        shimmer: { '0%': { backgroundPosition: '0% 50%' }, '50%': { backgroundPosition: '100% 50%' }, '100%': { backgroundPosition: '0% 50%' } }
                    }
                }
            }
        }
    </script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getFirestore, collection, addDoc, getDocs, doc, updateDoc, onSnapshot, query, orderBy, setDoc, deleteDoc, getDoc, where } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCS3l25GbS_yidhrMi9r7pYhKx9o10a_jE",
            authDomain: "messenger-7d75e.firebaseapp.com",
            projectId: "messenger-7d75e",
            storageBucket: "messenger-7d75e.firebasestorage.app",
            messagingSenderId: "424767410004",
            appId: "1:424767410004:web:a077386093867e308f82c1"
        };

        try {
            const app = initializeApp(firebaseConfig);
            window.db = getFirestore(app);
            window.firebaseOps = { collection, addDoc, getDocs, doc, updateDoc, onSnapshot, query, orderBy, setDoc, deleteDoc, getDoc, where };
            console.log("Appers Database Connected");
        } catch (e) {
            console.error("Firebase Init Error:", e);
        }
    </script>

    <style>
        body { transition: background-color 0.3s, color 0.3s; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .fade-in { animation: pop 0.3s ease-out; }
        .logo-text { background: linear-gradient(to right, #fbbf24, #f59e0b); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        
        /* NFT Rarities */
        .nft-bg-green { background: linear-gradient(135deg, #4ade80 0%, #16a34a 100%); }
        .nft-bg-blue { background: linear-gradient(135deg, #60a5fa 0%, #2563eb 100%); }
        .nft-bg-red { background: linear-gradient(135deg, #f87171 0%, #dc2626 100%); }
        .nft-bg-yellow { background: linear-gradient(135deg, #facc15 0%, #ca8a04 100%); }
        .nft-bg-gray { background: linear-gradient(135deg, #94a3b8 0%, #475569 100%); }
        .nft-bg-black { background: linear-gradient(135deg, #334155 0%, #020617 100%); border: 1px solid rgba(255,255,255,0.2); }
        .nft-bg-gold { 
            background: linear-gradient(45deg, #bf953f, #fcf6ba, #b38728, #fbf5b7, #aa771c);
            background-size: 200% 200%;
            animation: shimmer 3s ease infinite;
            border: 1px solid #fff;
            box-shadow: 0 0 15px rgba(251, 191, 36, 0.4);
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-900 dark:bg-dark-bg dark:text-dark-text transition-colors duration-300">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // --- CONSTANTS ---
        const NFT_CATALOG = [
            { id: 'banana', name: '–ë–∞–Ω–∞–Ω', cost: 10, image: 'https://pngicon.ru/file/uploads/banan.png' },
            { id: 'doggy', name: '–î–æ–≥–≥–∏', cost: 50, image: 'https://transcode-v2.app.engoo.com/image/fetch/f_auto,c_lfill,w_300,dpr_3/https://assets.app.engoo.com/organizations/5d2656f1-9162-461d-88c7-b2505623d8cb/images/2YcjMiWiJMGI36fisbtlZJ.jpeg' },
            { id: 'sonic', name: 'Sonic', cost: 1000, image: 'https://i.redd.it/lbujwupwym2c1.png', limit: 250 }
        ];

        const RARITY_MAP = {
            "nft-bg-green": { label: "–ó–µ–ª–µ–Ω—ã–π", mult: 0.85 },
            "nft-bg-blue": { label: "–°–∏–Ω–∏–π", mult: 0.85 },
            "nft-bg-red": { label: "–ö—Ä–∞—Å–Ω—ã–π", mult: 0.85 },
            "nft-bg-yellow": { label: "–ñ–µ–ª—Ç—ã–π", mult: 0.85 },
            "nft-bg-gray": { label: "–°–µ—Ä—ã–π", mult: 0.85 },
            "nft-bg-black": { label: "–ß–µ—Ä–Ω—ã–π", mult: 1.5 },
            "nft-bg-gold": { label: "GOLD LEGENDA", mult: 3.0 }
        };

        const TRANSLATIONS = {
            ru: { 
                home: "–ì–ª–∞–≤–Ω–∞—è", profile: "–ü—Ä–æ—Ñ–∏–ª—å", messages: "–°–æ–æ–±—â–µ–Ω–∏—è", settings: "–ù–∞—Å—Ç—Ä–æ–π–∫–∏", logout: "–í—ã–π—Ç–∏", theme: "–¢–µ–º–∞", lang: "–Ø–∑—ã–∫", light: "–°–≤–µ—Ç–ª–∞—è", dark: "–¢—ë–º–Ω–∞—è", subs: "–ü–æ–¥–ø–∏—Å—á–∏–∫–∏", subscribe: "–ü–æ–¥–ø–∏—Å–∞—Ç—å—Å—è", subscribed: "–í—ã –ø–æ–¥–ø–∏—Å–∞–Ω—ã", edit: "–ò–∑–º–µ–Ω–∏—Ç—å", save: "–°–æ—Ö—Ä–∞–Ω–∏—Ç—å", cancel: "–û—Ç–º–µ–Ω–∞", publish: "–û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å", post_placeholder: "–ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç?", admin_panel: "–ü–∞–Ω–µ–ª—å –ê–¥–º–∏–Ω–∞", search: "–ü–æ–∏—Å–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π...", ban_user: "–ó–ê–ë–ê–ù–ò–¢–¨", delete_post: "–£–¥–∞–ª–∏—Ç—å", boost_likes: "+–õ–∞–π–∫–∏", boost_subs: "+–°–∞–±—ã", boost_gems: "+–ê–ª–º–∞–∑—ã", pin_post: "–ó–∞–∫—Ä–µ–ø–∏—Ç—å", amount: "–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ", close: "–ó–∞–∫—Ä—ã—Ç—å", banned_title: "–ù–ê–†–£–®–ò–¢–ï–õ–¨", banned_content: "nothing interesting", banned_login: "–í–ê–® –ê–ö–ö–ê–£–ù–¢ –ó–ê–ë–ê–ù–ï–ù", rank: "–†–∞–Ω–≥ / –°—Ç–∞—Ç—É—Å", give_tick: "–í—ã–¥–∞—Ç—å –≥–∞–ª–æ—á–∫—É", create_acc: "–°–æ–∑–¥–∞—Ç—å –∞–∫–∫–∞—É–Ω—Ç", login: "–í–æ–π—Ç–∏", name: "–ò–º—è", pass: "–ü–∞—Ä–æ–ª—å", wait_post: "–ü–æ–¥–æ–∂–¥–∏—Ç–µ —Å–µ–∫. –ø–µ—Ä–µ–¥ –ø–æ—Å—Ç–æ–º:", wait_comm: "–ü–æ–¥–æ–∂–¥–∏—Ç–µ —Å–µ–∫. –ø–µ—Ä–µ–¥ –∫–æ–º–º–µ–Ω—Ç–æ–º:", change_banner: "–ë–∞–Ω–Ω–µ—Ä", change_avatar: "–ê–≤–∞—Ç–∞—Ä–∫–∞", write_msg: "–ù–∞–ø–∏—Å–∞—Ç—å", no_chats: "–ù–µ—Ç —á–∞—Ç–æ–≤", select_chat: "–í—ã–±–µ—Ä–∏—Ç–µ —á–∞—Ç", type_msg: "–°–æ–æ–±—â–µ–Ω–∏–µ...", reply: "–û—Ç–≤–µ—Ç–∏—Ç—å...",
                diamonds: "–ê–ª–º–∞–∑—ã", send_nft: "–ü–æ–¥–∞—Ä–∏—Ç—å NFT", not_enough_money: "–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –∞–ª–º–∞–∑–æ–≤!", buy: "–ö—É–ø–∏—Ç—å –∑–∞", signature: "–¢–µ–∫—Å—Ç –ø–æ–¥–∞—Ä–∫–∞", nft_received: "–í–∞–º –æ—Ç–ø—Ä–∞–≤–∏–ª–∏ NFT!", sell_nft: "–ü—Ä–æ–¥–∞—Ç—å", pin_nft: "–ó–∞–∫—Ä–µ–ø–∏—Ç—å", unpin_nft: "–û—Ç–∫—Ä–µ–ø–∏—Ç—å", hide_nft: "–°–∫—Ä—ã—Ç—å", show_nft: "–ü–æ–∫–∞–∑–∞—Ç—å", collection: "–ö–æ–ª–ª–µ–∫—Ü–∏—è", sell_confirm: "–ü—Ä–æ–¥–∞—Ç—å –∑–∞ 85% —Å—Ç–æ–∏–º–æ—Å—Ç–∏?",
                show_diamonds: "–ü–æ–∫–∞–∑—ã–≤–∞—Ç—å –∞–ª–º–∞–∑—ã", show_diamonds_desc: "–î–ª—è –¥—Ä—É–≥–∏—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –≤ –≤–∞—à–µ–º –ø—Ä–æ—Ñ–∏–ª–µ", me: "–í—ã", nft_menu_title: "–î–µ–π—Å—Ç–≤–∏—è —Å NFT", sell_all: "–ü—Ä–æ–¥–∞—Ç—å –í–°–Å", collection_value: "–°—Ç–æ–∏–º–æ—Å—Ç—å –∫–æ–ª–ª–µ–∫—Ü–∏–∏",
                block: "–ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å", unblock: "–†–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å", you_are_banned: "–í—ã –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω—ã —ç—Ç–∏–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º!", my_subs: "–ú–æ–∏ –ø–æ–¥–ø–∏—Å–∫–∏", set_title: "–¢–∏—Ç—É–ª", sold_out: "–ü–†–û–î–ê–ù–û", left: "–û—Å—Ç.", favorites: "–ò–∑–±—Ä–∞–Ω–Ω–æ–µ (–í—ã)"
            },
            en: { 
                home: "Home", profile: "Profile", messages: "Messages", settings: "Settings", logout: "Log out", theme: "Theme", lang: "Language", light: "Light", dark: "Dark", subs: "Followers", subscribe: "Subscribe", subscribed: "Subscribed", edit: "Edit", save: "Save", cancel: "Cancel", publish: "Publish", post_placeholder: "What's happening?", admin_panel: "Admin Panel", search: "Search users...", ban_user: "BAN", delete_post: "Delete", boost_likes: "+Likes", boost_subs: "+Subs", boost_gems: "+Gems", pin_post: "Pin", amount: "Amount", close: "Close", banned_title: "BANNED", banned_content: "nothing interesting", banned_login: "BANNED", create_acc: "Sign up", login: "Log in", name: "Name", pass: "Password", wait_post: "Wait sec:", wait_comm: "Wait sec:", change_banner: "Banner", change_avatar: "Avatar", write_msg: "Message", no_chats: "No chats", select_chat: "Select chat", type_msg: "Message...", reply: "Reply...",
                diamonds: "Diamonds", send_nft: "Gift NFT", not_enough_money: "Not enough diamonds!", buy: "Buy for", signature: "Gift text", nft_received: "You received an NFT!", sell_nft: "Sell", pin_nft: "Pin", unpin_nft: "Unpin", hide_nft: "Hide", show_nft: "Show", collection: "Collection", sell_confirm: "Sell for 85% value?",
                show_diamonds: "Show diamonds balance", show_diamonds_desc: "Other users won't see your balance", me: "You", nft_menu_title: "NFT Actions", sell_all: "Sell ALL", collection_value: "Collection Value",
                block: "Block", unblock: "Unblock", you_are_banned: "You are blocked by this user!", my_subs: "My Subscriptions", set_title: "Title", sold_out: "SOLD OUT", left: "Left", favorites: "Saved Messages (You)"
            }
        };

        // --- ICONS ---
        const Icon = ({ name, size = 24, className = "", fill = "none" }) => {
            const iconsMap = {
                Home: <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z" />,
                User: <><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2" /><circle cx="12" cy="7" r="4" /></>,
                LogOut: <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4M16 17l5-5-5-5M21 12H9" />,
                Plus: <><line x1="12" y1="5" x2="12" y2="19" /><line x1="5" y1="12" x2="19" y2="12" /></>,
                Trash: <><polyline points="3 6 5 6 21 6" /><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2" /></>,
                Heart: <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z" />,
                Message: <path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z" />,
                Image: <><rect x="3" y="3" width="18" height="18" rx="2" ry="2" /><circle cx="8.5" cy="8.5" r="1.5" /><polyline points="21 15 16 10 5 21" /></>,
                X: <><line x1="18" y1="6" x2="6" y2="18" /><line x1="6" y1="6" x2="18" y2="18" /></>,
                Send: <><line x1="22" y1="2" x2="11" y2="13" /><polygon points="22 2 15 22 11 13 2 9 22 2" /></>,
                Settings: <><circle cx="12" cy="12" r="3" /><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1-2 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z" /></>,
                Moon: <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z" />,
                Sun: <><circle cx="12" cy="12" r="5" /><line x1="12" y1="1" x2="12" y2="3" /><line x1="12" y1="21" x2="12" y2="23" /><line x1="4.22" y1="4.22" x2="5.64" y2="5.64" /><line x1="18.36" y1="18.36" x2="19.78" y2="19.78" /><line x1="1" y1="12" x2="3" y2="12" /><line x1="21" y1="12" x2="23" y2="12" /><line x1="4.22" y1="19.78" x2="5.64" y2="18.36" /><line x1="18.36" y1="5.64" x2="19.78" y2="4.22" /></>,
                ArrowLeft: <><line x1="19" y1="12" x2="5" y2="12" /><polyline points="12 19 5 12 12 5" /></>,
                Diamond: (<g><path d="M6 3L3 8L12 21L21 8L18 3H6Z" fill="#fbbf24" fillOpacity="0.4" stroke="#fbbf24" strokeWidth="1.5" strokeLinejoin="round"/><path d="M6 3L12 8L18 3" fill="none" stroke="#fbbf24" strokeWidth="1.5" strokeLinejoin="round"/><path d="M3 8L12 8L21 8" fill="none" stroke="#fbbf24" strokeWidth="1.5" strokeLinejoin="round"/><path d="M12 21L8 8L12 3L16 8L12 21Z" fill="#fbbf24" fillOpacity="0.6" stroke="#fbbf24" strokeWidth="1.5" strokeLinejoin="round"/></g>),
                Gift: <><polyline points="20 12 20 22 4 22 4 12" /><rect x="2" y="7" width="20" height="5" /><line x1="12" y1="22" x2="12" y2="7" /><path d="M12 7H7.5a2.5 2.5 0 0 1 0-5C11 2 12 7 12 7z" /><path d="M12 7h4.5a2.5 2.5 0 0 0 0-5C13 2 12 7 12 7z" /></>,
                Search: <circle cx="11" cy="11" r="8" />,
                Pin: <><line x1="12" y1="17" x2="12" y2="22" /><path d="M5 17h14v-1.76a2 2 0 0 0-1.11-1.79l-1.78-.9A2 2 0 0 1 15 10.76V6h1a2 2 0 0 0 0-4H8a2 2 0 0 0 0 4h1v4.76a2 2 0 0 1-1.11 1.79l-1.78.9A2 2 0 0 0 5 15.24Z" /></>,
                Verified: (<g><path d="M22.5 12.5c0-1.58-.875-2.95-2.148-3.6.518-1.59.066-3.368-1.09-4.524-1.156-1.156-2.932-1.608-4.524-1.09C14.08 2.013 12.56 1.25 11.25 1.25c-1.58 0-2.95.875-3.6 2.148-1.59-.518-3.368-.066-4.524 1.09-1.156 1.156-1.608 2.932-1.09 4.524C.76 9.79-.125 11.31.125 12.5c0 1.58.875 2.95 2.148 3.6-.518 1.59-.066 3.368 1.09 4.524 1.156 1.156 2.932 1.608 4.524 1.09.65 1.272 2.17 2.036 3.48 2.036 1.58 0 2.95-.875 3.6-2.148 1.59.518 3.368.066 4.524-1.09 1.156-1.156 1.608-2.932 1.09-4.524 1.272-.65 2.036-2.17 2.036-3.48z" fill="#007bff"/><path d="M10 17l-5-5 1.41-1.42L10 14.17l7.59-7.59L19 8l-9 9z" fill="white"/></g>),
                Trophy: <path d="M8 21h8M12 17v4M7 4h10c0 6-2.6 8-5 8s-5-2-5-8zM6 4H4a2 2 0 0 0-2 2v2c0 3 1.5 5 4 6M18 4h2a2 2 0 0 1 2 2v2c0 3-1.5 5-4 6" />,
                Shield: <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z" />
            };
            return <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill={fill} stroke="currentColor" strokeWidth={name === 'Verified' || name === 'Diamond' ? 0 : 2} strokeLinecap="round" strokeLinejoin="round" className={className}>{iconsMap[name] || null}</svg>;
        };

        // --- COMPONENTS ---
        
        const Avatar = ({ src, name, size = "w-10 h-10", className = "", isBanned }) => {
            const [err, setErr] = useState(false);
            useEffect(() => { setErr(false); }, [src]);
            if (isBanned) return <div className={`${size} rounded-full bg-gray-300 dark:bg-gray-700 flex items-center justify-center text-gray-500 font-bold ${className}`}>?</div>;
            if (!src || err) return <div className={`${size} rounded-full bg-blue-500 text-white flex items-center justify-center font-bold text-lg ${className}`}>{name ? name[0].toUpperCase() : '?'}</div>;
            return <img src={src} alt={name} className={`${size} rounded-full object-cover bg-gray-200 ${className}`} onError={()=>setErr(true)} />;
        };

        const VerifiedBadge = ({ isVerified, customTitle, isBanned, customTitleColor, t }) => {
            if (isBanned) return <span className="ml-1 px-1.5 py-0.5 bg-red-600 text-white text-[10px] font-bold rounded">–ù–ê–†–£–®–ò–¢–ï–õ–¨</span>;
            return (
                <span className="inline-flex items-center gap-1 ml-1 align-middle">
                    {isVerified && <Icon name="Verified" size={18}/>}
                    {customTitle && (
                        <span className="px-1.5 py-0.5 text-[10px] font-bold rounded border" style={{ backgroundColor: customTitleColor || '#f3f4f6', color: customTitleColor ? '#fff' : '#4b5563', borderColor: customTitleColor || '#e5e7eb' }}>
                            {customTitle}
                        </span>
                    )}
                </span>
            );
        };

        const FileUpload = ({ onFileSelect }) => {
            const ref = useRef(null);
            const handle = (e) => {
                const f = e.target.files[0];
                if(f) {
                    if(f.size > 2000000) return alert("–§–∞–π–ª —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π! –ú–∞–∫—Å 2–ú–ë");
                    // –°–∂–∞—Ç–∏–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –ø–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π
                    const r = new FileReader();
                    r.onload = (event) => {
                        const img = new Image();
                        img.onload = () => {
                            const canvas = document.createElement('canvas');
                            let width = img.width;
                            let height = img.height;
                            const MAX_WIDTH = 800;
                            const MAX_HEIGHT = 800;
                            if (width > height) {
                                if (width > MAX_WIDTH) { height *= MAX_WIDTH / width; width = MAX_WIDTH; }
                            } else {
                                if (height > MAX_HEIGHT) { width *= MAX_HEIGHT / height; height = MAX_HEIGHT; }
                            }
                            canvas.width = width;
                            canvas.height = height;
                            const ctx = canvas.getContext('2d');
                            ctx.drawImage(img, 0, 0, width, height);
                            onFileSelect(canvas.toDataURL('image/jpeg', 0.7)); // –°–∂–∏–º–∞–µ–º –¥–æ 70% –∫–∞—á–µ—Å—Ç–≤–∞
                        };
                        img.src = event.target.result;
                    };
                    r.readAsDataURL(f);
                }
            };
            return <><input type="file" ref={ref} className="hidden" accept="image/*" onChange={handle}/><button onClick={() => ref.current.click()} className="p-2 text-blue-500 hover:bg-blue-50 dark:hover:bg-gray-800 rounded-full transition"><Icon name="Image" size={20}/></button></>;
        };

        const SubsModal = ({ isOpen, onClose, user, users, t, goToProfile }) => {
            if(!isOpen) return null;
            const following = users.filter(u => (user.following || []).includes(u.id));
            return (
                <div className="fixed inset-0 bg-black/70 z-50 flex items-center justify-center p-4 backdrop-blur-sm">
                    <div className="bg-white dark:bg-dark-card w-full max-w-sm rounded-2xl p-6 shadow-2xl fade-in border dark:border-gray-700 flex flex-col max-h-[80vh]">
                        <div className="flex justify-between items-center mb-4 font-bold text-xl dark:text-white">
                            <h3>{t.my_subs} ({following.length})</h3>
                            <button onClick={onClose}><Icon name="X"/></button>
                        </div>
                        <div className="flex-1 overflow-y-auto space-y-2 no-scrollbar">
                            {following.length === 0 && <p className="text-gray-500 text-center py-4">–í—ã –ø–æ–∫–∞ –Ω–∏ –Ω–∞ –∫–æ–≥–æ –Ω–µ –ø–æ–¥–ø–∏—Å–∞–Ω—ã.</p>}
                            {following.map(u => (
                                <div key={u.id} className="flex items-center gap-3 p-2 hover:bg-gray-50 dark:hover:bg-gray-800 rounded-xl cursor-pointer" onClick={() => { onClose(); goToProfile(u.id); }}>
                                    <Avatar src={u.avatar} name={u.name} />
                                    <div><div className="font-bold dark:text-white">{u.name}</div><div className="text-xs text-gray-500">@{u.username}</div></div>
                                </div>
                            ))}
                        </div>
                    </div>
                </div>
            );
        };

        const AuthScreen = ({ onLogin, t }) => {
            const [isReg, setIsReg] = useState(false);
            const [form, setForm] = useState({username:'', password:'', name:''});
            const [error, setError] = useState('');

            const handleSubmit = async (e) => {
                e.preventDefault(); setError('');
                if (!window.db) return setError("–û—à–∏–±–∫–∞ –±–∞–∑—ã");
                try {
                    const usersRef = window.firebaseOps.collection(window.db, 'users');
                    const snapshot = await window.firebaseOps.getDocs(usersRef);
                    const users = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
                    const findUser = (uname) => users.find(u => u.username.toLowerCase() === uname.toLowerCase());

                    if (isReg) {
                        if (findUser(form.username)) return setError("–õ–æ–≥–∏–Ω –∑–∞–Ω—è—Ç");
                        const newUser = { username: form.username, password: form.password, name: form.name, handle: '@'+form.username, avatar: '', banner: '', joined: new Date().toLocaleDateString(), bio: 'Hi!', isVerified: false, customTitle: '', customTitleColor: '', followers: 0, diamonds: 0, nfts: [], isBanned: false, following: [], showDiamonds: true, timestamp: Date.now(), blockedUsers: [] };
                        const ref = await window.firebaseOps.addDoc(usersRef, newUser);
                        onLogin({ id: ref.id, ...newUser });
                    } else {
                        const user = users.find(u => u.username.toLowerCase() === form.username.toLowerCase() && u.password === form.password);
                        if (user) { if (user.isBanned) return setError(t.banned_login); onLogin(user); } else setError("–ù–µ–≤–µ—Ä–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ");
                    }
                } catch(e) { setError(e.message); }
            };

            return (
                <div className="min-h-screen flex items-center justify-center p-4 bg-white dark:bg-dark-bg transition-colors duration-300 text-center">
                    <div className="w-full max-w-sm fade-in">
                        <div className="mb-10 inline-flex items-center gap-3">
                             <div className="p-3 bg-gold rounded-2xl shadow-lg flex items-center justify-center transition hover:rotate-6"><Icon name="Home" size={32} fill="white" className="text-white"/></div>
                             <h1 className="text-4xl font-black logo-text tracking-tighter">Appers</h1>
                        </div>
                        {error && <div className="bg-red-50 text-red-500 p-3 rounded-lg mb-4 text-sm font-bold">{error}</div>}
                        <form onSubmit={handleSubmit} className="space-y-3">
                            {isReg && <input className="w-full p-3 bg-gray-50 dark:bg-gray-800 rounded-lg dark:text-white border border-gray-200 dark:border-gray-700 outline-none focus:border-gold" placeholder={t.name} value={form.name} onChange={e=>setForm({...form, name:e.target.value})} />}
                            <input className="w-full p-3 bg-gray-50 dark:bg-gray-800 rounded-lg dark:text-white border border-gray-200 dark:border-gray-700 outline-none focus:border-gold" placeholder="–õ–æ–≥–∏–Ω" value={form.username} onChange={e=>setForm({...form, username:e.target.value})} />
                            <input className="w-full p-3 bg-gray-50 dark:bg-gray-800 rounded-lg dark:text-white border border-gray-200 dark:border-gray-700 outline-none focus:border-gold" type="password" placeholder={t.pass} value={form.password} onChange={e=>setForm({...form, password:e.target.value})} />
                            <button className="w-full bg-black dark:bg-blue-600 text-white p-4 rounded-xl font-bold hover:bg-gray-800 shadow-lg active:scale-95 transition">{isReg ? t.create_acc : t.login}</button>
                        </form>
                        <div className="mt-8"><button onClick={()=>{setIsReg(!isReg); setError('');}} className="text-sm font-bold text-gray-400 hover:text-black dark:hover:text-white transition">{isReg ? t.login : t.create_acc}</button></div>
                    </div>
                </div>
            );
        };

        const EditProfileModal = ({ user, isOpen, onClose, onSave, t }) => {
            const [data, setData] = useState({ name: "", bio: "", avatar: "", banner: "" });
            useEffect(() => { if (user) setData({ name: user.name, bio: user.bio || "", avatar: user.avatar || "", banner: user.banner || "" }); }, [user, isOpen]);
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 bg-black/60 z-50 flex items-center justify-center p-4 backdrop-blur-sm">
                    <div className="bg-white dark:bg-dark-card rounded-2xl w-full max-w-md p-6 shadow-2xl fade-in border border-gray-200 dark:border-dark-border">
                        <div className="flex justify-between items-center mb-6"><h3 className="font-bold text-xl dark:text-white">{t.profile}</h3><button onClick={onClose}><Icon name="X" className="dark:text-white"/></button></div>
                        <div className="space-y-4">
                            <div className="flex items-center gap-4"><Avatar src={data.avatar} name={data.name} size="w-16 h-16" className="border-2 border-gray-200" /><div className="flex gap-2"><FileUpload onFileSelect={url => setData({...data, avatar: url})} /><span className="text-sm text-gray-500 self-center">–ê–≤–∞—Ç–∞—Ä–∫–∞</span></div></div>
                            <div className="flex gap-2 items-center"><div className="w-16 h-8 bg-gray-200 rounded overflow-hidden bg-cover bg-center" style={{backgroundImage: `url(${data.banner})`}}></div><div className="flex gap-2"><FileUpload onFileSelect={url => setData({...data, banner: url})} /><span className="text-sm text-gray-500 self-center">–ë–∞–Ω–Ω–µ—Ä</span></div></div>
                            <div><label className="text-xs font-bold text-gray-500 uppercase">{t.name}</label><input className="w-full bg-transparent border-b-2 border-gray-100 dark:border-gray-700 p-2 focus:border-black dark:focus:border-blue-500 outline-none font-medium dark:text-white" value={data.name} onChange={e => setData({...data, name: e.target.value})} /></div>
                            <div><label className="text-xs font-bold text-gray-500 uppercase">Bio</label><textarea className="w-full bg-transparent border-b-2 border-gray-100 dark:border-gray-700 p-2 focus:border-black dark:focus:border-blue-500 outline-none resize-none dark:text-white" rows="3" value={data.bio} onChange={e => setData({...data, bio: e.target.value})} /></div>
                            <button onClick={() => onSave(data)} className="w-full bg-black dark:bg-blue-600 text-white font-bold py-3 rounded-xl hover:bg-gray-800 transition active:scale-95">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                        </div>
                    </div>
                </div>
            );
        };

        const SettingsModal = ({ isOpen, onClose, theme, toggleTheme, lang, toggleLang, onLogout, currentUser, openAdmin, t, onUpdateUser }) => {
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 bg-black/60 z-50 flex items-center justify-center p-4">
                    <div className="bg-white dark:bg-dark-card w-full max-w-sm rounded-2xl p-6 shadow-2xl fade-in border border-gray-200 dark:border-dark-border">
                        <div className="flex justify-between mb-4 font-bold text-xl dark:text-white"><h3>{t.settings}</h3><button onClick={onClose}><Icon name="X" className="dark:text-white"/></button></div>
                        <div className="space-y-3">
                            <button onClick={toggleTheme} className="flex items-center justify-between w-full p-4 rounded-xl bg-gray-50 dark:bg-gray-800 transition font-bold dark:text-white"><span className="flex items-center gap-2"><Icon name={theme==='light'?'Moon':'Sun'}/> {t.theme}</span><span className="text-sm text-gray-500">{theme === 'light' ? t.light : t.dark}</span></button>
                            <button onClick={toggleLang} className="flex items-center justify-between w-full p-4 rounded-xl bg-gray-50 dark:bg-gray-800 transition font-bold dark:text-white"><span className="flex items-center gap-2"><Icon name="Globe"/> {t.lang}</span><span className="text-sm text-gray-500 uppercase">{lang}</span></button>
                            <div className="p-4 rounded-xl bg-gray-50 dark:bg-gray-800 border dark:border-gray-700">
                                <label className="flex items-center justify-between cursor-pointer group">
                                    <div><span className="font-bold dark:text-white flex items-center gap-2 transition group-hover:text-gold"><Icon name="Diamond" size={20} fill="currentColor" className="text-gold"/> {t.show_diamonds}</span><p className="text-[10px] text-gray-500 mt-0.5">{t.show_diamonds_desc}</p></div>
                                    <input type="checkbox" className="w-5 h-5 accent-blue-500 rounded" checked={currentUser.showDiamonds !== false} onChange={e => onUpdateUser(currentUser.id, { showDiamonds: e.target.checked })} />
                                </label>
                            </div>
                            {currentUser.username.toLowerCase() === 'baton4ik' && <button onClick={openAdmin} className="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-3 rounded-xl flex items-center justify-center gap-2 shadow-lg transition active:scale-95"><Icon name="Trophy"/> {t.admin_panel}</button>}
                            <button onClick={onLogout} className="w-full bg-gray-200 dark:bg-gray-700 text-black dark:text-white p-3 rounded-xl font-bold transition hover:bg-gray-300 dark:hover:bg-gray-600">{t.logout}</button>
                        </div>
                    </div>
                </div>
            );
        };

        const NftMenuModal = ({ isOpen, onClose, nft, onAction, isOwner, t }) => {
            if(!isOpen || !nft) return null;
            const [showConfirmSell, setShowConfirmSell] = useState(false);
            const rarityInfo = RARITY_MAP[nft.rarityClass] || { label: "–°—Ç–∞–Ω–¥–∞—Ä—Ç", mult: 0.85 };
            const sellPrice = Math.floor(nft.cost * rarityInfo.mult);
            return (
                <div className="fixed inset-0 bg-black/80 z-[80] flex items-center justify-center p-4 backdrop-blur-sm">
                    <div className="bg-white dark:bg-dark-card w-full max-w-xs rounded-2xl overflow-hidden shadow-2xl fade-in border dark:border-gray-700">
                        <div className={`p-6 text-center border-b dark:border-gray-700 ${nft.rarityClass}`}>
                            <img src={nft.image} className="w-24 h-24 mx-auto object-contain mb-4 drop-shadow-lg" />
                            <h3 className="font-bold text-lg text-white drop-shadow-sm">{nft.name}</h3>
                            <p className="text-[10px] uppercase font-black text-white/90 tracking-widest mt-1">–§–æ–Ω: {rarityInfo.label}</p>
                            {nft.signature && <p className="text-sm italic text-white mt-3 border-t border-dashed border-white/20 pt-2">"{nft.signature}"</p>}
                        </div>
                        <div className="p-2 space-y-1">
                            {!showConfirmSell ? (
                                <>
                                    {isOwner && (
                                        <>
                                            <button onClick={()=>onAction(nft, 'pin')} className="w-full flex items-center justify-center gap-2 py-3 hover:bg-gray-50 dark:hover:bg-gray-800 font-bold dark:text-white transition"><Icon name="Pin" size={18} fill={nft.pinned ? "currentColor" : "none"} className="text-gold"/> {nft.pinned ? t.unpin_nft : t.pin_nft}</button>
                                            <button onClick={()=>onAction(nft, 'hide')} className="w-full flex items-center justify-center gap-2 py-3 hover:bg-gray-50 dark:hover:bg-gray-800 font-bold dark:text-white transition"><Icon name="X" size={18}/> {nft.hidden ? t.show_nft : t.hide_nft}</button>
                                            <button onClick={()=>setShowConfirmSell(true)} className="w-full flex items-center justify-center gap-2 py-3 hover:bg-gray-50 dark:hover:bg-gray-800 font-bold text-red-500 transition"><Icon name="Diamond" size={18} fill="currentColor"/> {t.sell_nft} ({sellPrice} üíé)</button>
                                        </>
                                    )}
                                    <button onClick={onClose} className="w-full py-3 hover:bg-gray-50 dark:hover:bg-gray-800 font-medium text-gray-500 dark:text-gray-400 transition">–ó–∞–∫—Ä—ã—Ç—å</button>
                                </>
                            ) : (
                                <div className="p-4 text-center">
                                    <p className="font-bold mb-4 dark:text-white">{t.sell_confirm}</p>
                                    <div className="flex gap-2">
                                        <button onClick={()=>onAction(nft, 'sell')} className="flex-1 bg-red-500 text-white font-bold py-2 rounded-lg transition active:scale-95">–ü—Ä–æ–¥–∞—Ç—å</button>
                                        <button onClick={()=>setShowConfirmSell(false)} className="flex-1 bg-gray-200 dark:bg-gray-700 dark:text-white font-bold py-2 rounded-lg transition active:scale-95">–û—Ç–º–µ–Ω–∞</button>
                                    </div>
                                </div>
                            )}
                        </div>
                    </div>
                </div>
            );
        };

        const SendNFTModal = ({ isOpen, onClose, onSend, t, balance, users }) => {
            const [selected, setSelected] = useState(null);
            const [sign, setSign] = useState("");
            const [revealing, setRevealing] = useState(false);
            const [currentSpinBg, setCurrentSpinBg] = useState("nft-bg-green");
            const [error, setError] = useState(null);
            const bgs = ["nft-bg-green", "nft-bg-blue", "nft-bg-red", "nft-bg-yellow", "nft-bg-gray", "nft-bg-black", "nft-bg-gold"];

            const getSoldAmount = (nftId) => {
                if(!users) return 0;
                let count = 0;
                users.forEach(u => {
                    if(u.nfts) {
                        u.nfts.forEach(n => { if(n.id === nftId) count++; });
                    }
                });
                return count;
            };

            const startRevealing = () => {
                if(balance < selected.cost) { setError(t.not_enough_money); setTimeout(()=>setError(null), 3000); return; }
                if(selected.limit) {
                    const sold = getSoldAmount(selected.id);
                    if(sold >= selected.limit) { setError(t.sold_out); setTimeout(()=>setError(null), 3000); return; }
                }
                
                setRevealing(true);
                let count = 0;
                const interval = setInterval(() => {
                    setCurrentSpinBg(bgs[Math.floor(Math.random() * bgs.length)]);
                    count++;
                    if(count > 20) {
                        clearInterval(interval);
                        const roll = Math.random() * 100;
                        let rarity = "nft-bg-green";
                        if(roll < 90) rarity = bgs[Math.floor(Math.random() * 5)];
                        else if(roll < 98) rarity = "nft-bg-black";
                        else rarity = "nft-bg-gold"; 
                        onSend(selected, sign, rarity);
                        setRevealing(false); setSelected(null); setSign("");
                    }
                }, 80);
            };

            if(!isOpen) return null;

            return (
                <div className="fixed inset-0 bg-black/80 z-[70] flex items-center justify-center p-4 backdrop-blur-sm">
                    <div className="bg-white dark:bg-dark-card w-full max-w-sm rounded-xl p-6 shadow-2xl relative overflow-hidden border dark:border-gray-700 max-h-[90vh] overflow-y-auto">
                        <div className="flex justify-between items-center mb-4 font-bold dark:text-white"><h3>{t.send_nft}</h3><button onClick={onClose}><Icon name="X"/></button></div>
                        {error && <div className="absolute top-0 left-0 w-full bg-red-500 text-white text-center py-2 font-bold text-sm fade-in">{error}</div>}
                        {!revealing ? (
                            <div className="space-y-4">
                                {NFT_CATALOG.map(nft => {
                                    const sold = nft.limit ? getSoldAmount(nft.id) : 0;
                                    const isSoldOut = nft.limit && sold >= nft.limit;
                                    
                                    return (
                                        <div key={nft.id} onClick={()=> !isSoldOut && setSelected(nft)} className={`p-3 rounded-xl border-2 cursor-pointer flex gap-3 transition relative overflow-hidden ${selected?.id===nft.id ? 'border-gold bg-gold/10' : 'border-gray-200 dark:border-gray-700'} ${isSoldOut ? 'opacity-50 grayscale cursor-not-allowed' : ''}`}>
                                            <img src={nft.image} className="w-16 h-16 object-contain"/>
                                            <div className="flex-1">
                                                <div className="font-bold dark:text-white flex justify-between">{nft.name} {nft.limit && <span className={`text-[10px] px-1.5 py-0.5 rounded ${isSoldOut ? 'bg-red-500 text-white' : 'bg-gray-200 text-gray-700'}`}>{isSoldOut ? t.sold_out : `${t.left}: ${nft.limit - sold}/${nft.limit}`}</span>}</div>
                                                <div className="text-sm text-gold flex items-center gap-1 font-bold"><Icon name="Diamond" size={14} fill="currentColor" className="text-gold"/> {nft.cost}</div>
                                            </div>
                                        </div>
                                    );
                                })}
                                <input className="w-full bg-gray-100 dark:bg-gray-800 p-3 rounded-lg text-sm dark:text-white outline-none focus:ring-2 focus:ring-gold" placeholder={t.signature} value={sign} onChange={e=>setSign(e.target.value)}/>
                                <div className="flex justify-between font-bold border-t dark:border-gray-700 pt-2"><span className="dark:text-gray-400">–ë–∞–ª–∞–Ω—Å:</span><span className="text-gold flex items-center gap-1"><Icon name="Diamond" size={14} fill="currentColor"/> {balance}</span></div>
                                <button onClick={startRevealing} disabled={!selected} className="w-full bg-gold text-white font-bold py-4 rounded-xl shadow-lg hover:bg-yellow-500 transition active:scale-95 disabled:opacity-50">{selected ? `${t.buy} ${selected.cost} üíé` : t.send_nft}</button>
                            </div>
                        ) : (
                            <div className="py-10 text-center flex flex-col items-center">
                                <div className={`w-32 h-32 rounded-3xl ${currentSpinBg} flex items-center justify-center shadow-2xl transition-all duration-75`}>
                                    <img src={selected.image} className="w-24 h-24 object-contain drop-shadow-md"/>
                                </div>
                                <p className="mt-6 font-bold text-lg dark:text-white animate-pulse">–ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Ä–µ–¥–∫–æ—Å—Ç–∏...</p>
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        const SuperAdminModal = ({ isOpen, onClose, target, type, onAction, t }) => {
            const [amount, setAmount] = useState(100);
            if (!isOpen || !target) return null;
            return (
                <div className="fixed inset-0 bg-black/70 z-50 flex items-center justify-center p-4 backdrop-blur-sm">
                    <div className="bg-white dark:bg-dark-card border border-gray-200 dark:border-dark-border rounded-xl w-full max-w-sm p-6 shadow-2xl">
                        <h3 className="font-black text-xl mb-4 text-red-600">‚ö° {t.admin_panel}</h3>
                        <p className="text-xs text-gray-500 mb-2">ID: {target.id}</p>
                        <div className="bg-gray-100 dark:bg-gray-800 p-3 rounded-lg mb-4"><label className="text-xs font-bold uppercase text-gray-500">{t.amount}</label><input type="number" value={amount} onChange={e => setAmount(Number(e.target.value))} className="w-full bg-transparent border-b border-gray-300 p-1 outline-none font-mono text-lg dark:text-white" /></div>
                        <div className="grid grid-cols-2 gap-2 mb-2"><button onClick={() => onAction('boost_likes', amount)} className="bg-blue-600 text-white py-2 rounded-lg font-bold text-sm">{t.boost_likes}</button><button onClick={() => onAction('boost_subs', amount)} className="bg-green-600 text-white py-2 rounded-lg font-bold text-sm">{t.boost_subs}</button></div>
                        <button onClick={() => onAction('boost_gems', amount)} className="w-full bg-cyan-500 text-white py-2 rounded-lg font-bold text-sm mb-2">{t.boost_gems}</button>
                        {type === 'post' && <button onClick={() => onAction('pin_post')} className="w-full bg-yellow-500 text-white py-2 rounded-lg font-bold text-sm mb-2">{t.pin_post}</button>}
                        <button onClick={() => onAction('delete')} className="w-full bg-orange-600 text-white py-2 rounded-lg font-bold text-sm mb-2">{t.delete_post}</button>
                        <button onClick={() => onAction('ban_author')} className="w-full bg-red-600 text-white py-2 rounded-lg font-bold text-sm">{t.ban_user}</button>
                        <button onClick={onClose} className="w-full mt-4 text-gray-400 text-sm">–ó–∞–∫—Ä—ã—Ç—å</button>
                    </div>
                </div>
            );
        };

        const GlobalAdminPanel = ({ isOpen, onClose, users, onUpdateUser, t }) => {
            const [search, setSearch] = useState("");
            if (!isOpen) return null;
            const filtered = users.filter(u => u.username.toLowerCase().includes(search.toLowerCase()));
            return (
                <div className="fixed inset-0 bg-black/80 z-50 flex items-center justify-center p-4">
                    <div className="bg-white dark:bg-dark-card w-full max-w-2xl h-[80vh] rounded-2xl shadow-2xl flex flex-col overflow-hidden fade-in border dark:border-gray-700">
                        <div className="p-4 border-b dark:border-dark-border flex justify-between items-center bg-red-600 text-white"><h2 className="font-bold text-lg flex items-center gap-2"><Icon name="Trophy"/> {t.admin_panel}</h2><button onClick={onClose}><Icon name="X" className="text-white"/></button></div>
                        <div className="p-4 bg-gray-50 dark:bg-gray-800 border-b dark:border-gray-700"><input className="w-full p-2 rounded border dark:bg-dark-card dark:text-white dark:border-gray-600 outline-none focus:border-red-500" placeholder={t.search} value={search} onChange={e => setSearch(e.target.value)} /></div>
                        <div className="flex-1 overflow-y-auto p-4 space-y-2">
                            {filtered.map(u => (
                                <div key={u.id} className="flex items-center justify-between p-3 bg-gray-50 dark:bg-gray-800 rounded-lg">
                                    <div className="flex items-center gap-3"><Avatar src={u.avatar} name={u.name} isBanned={u.isBanned} /><div><p className="font-bold text-sm dark:text-white flex items-center">{u.name} <VerifiedBadge isVerified={u.isVerified} customTitle={u.customTitle} customTitleColor={u.customTitleColor} isBanned={u.isBanned} t={t}/></p><p className="text-xs text-gray-500">@{u.username} ‚Ä¢ {Number(u.diamonds)||0} üíé</p></div></div>
                                    <div className="flex gap-2 flex-wrap justify-end">
                                        <button onClick={() => onUpdateUser(u.id, { isBanned: !u.isBanned })} className={`px-3 py-1 rounded text-xs font-bold text-white ${u.isBanned ? 'bg-green-500' : 'bg-red-500'}`}>{u.isBanned ? 'UNBAN' : 'BAN'}</button>
                                        <button onClick={() => onUpdateUser(u.id, { isVerified: !u.isVerified })} className="px-3 py-1 bg-blue-500 text-white rounded text-xs font-bold transition hover:bg-blue-600">‚úì</button>
                                        <button onClick={() => { const newTitle = prompt("–í–≤–µ–¥–∏—Ç–µ —Ç–∏—Ç—É–ª:", u.customTitle || ""); if(newTitle !== null) { const newColor = prompt("–¶–≤–µ—Ç (hex):", u.customTitleColor || "#fbbf24"); onUpdateUser(u.id, { customTitle: newTitle, customTitleColor: newColor }); }}} className="px-3 py-1 bg-purple-500 text-white rounded text-xs font-bold shadow-sm">{t.set_title}</button>
                                        <button onClick={() => { const amt = prompt(t.amount); if(amt) onUpdateUser(u.id, { diamonds: (Number(u.diamonds)||0) + Number(amt) }); }} className="px-3 py-1 bg-gold text-white rounded text-xs font-bold shadow-sm">+üíé</button>
                                    </div>
                                </div>
                            ))}
                        </div>
                    </div>
                </div>
            );
        };

        const PostItem = ({ post, currentUser, users, t, handleSecretClick, toggleLike, sendComment, goToProfile, deletePost, deleteComment }) => {
            const [openComments, setOpenComments] = useState(false);
            const [commentText, setCommentText] = useState("");
            const author = users.find(u => u.id === post.authorId) || {name:'Unknown', handle:'@?', isBanned:false};
            const isLiked = (post.likes||[]).includes(currentUser.id);
            const totalLikes = (Number(post.likes?.length) || 0) + (Number(post.fakeLikes) || 0);
            const isMyPost = currentUser.id === post.authorId;

            return (
                <article className={`p-4 border-b dark:border-gray-800 hover:bg-gray-50 dark:hover:bg-gray-800/50 transition ${post.isPinned ? 'bg-yellow-50 dark:bg-yellow-900/10 border-l-4 border-l-gold' : ''}`} onClick={(e) => { if(!['BUTTON','svg', 'path', 'INPUT', 'IMG', 'TEXTAREA'].includes(e.target.tagName)) handleSecretClick(post, 'post'); }}>
                    <div className="flex gap-3 relative group">
                        {isMyPost && <button onClick={(e) => { e.stopPropagation(); if(confirm(t.delete_post + "?")) deletePost(post.id); }} className="absolute top-0 right-0 p-1.5 text-gray-400 hover:text-red-500 opacity-0 group-hover:opacity-100 transition"><Icon name="Trash" size={16}/></button>}
                        <div className="cursor-pointer" onClick={(e)=>{e.stopPropagation(); goToProfile(author.id);}}><Avatar src={author.avatar} name={author.name} isBanned={author.isBanned}/></div>
                        <div className="flex-1 min-w-0">
                            <div className="flex items-center gap-1 cursor-pointer" onClick={(e)=>{e.stopPropagation(); goToProfile(author.id);}}>
                                <span className="font-bold hover:underline truncate dark:text-white">{author.name}</span>
                                <VerifiedBadge isVerified={author.isVerified} customTitle={author.isBanned?t.banned_title:author.customTitle} customTitleColor={author.customTitleColor} isBanned={author.isBanned} t={t}/>
                                <span className="text-gray-500 text-sm truncate">@{author.username}</span>
                            </div>
                            <p className="mt-1 text-[15px] dark:text-gray-200 whitespace-pre-wrap leading-normal">{author.isBanned ? t.banned_content : post.content}</p>
                            {post.image && !author.isBanned && <img src={post.image} className="mt-3 rounded-xl border dark:border-gray-700 w-full object-cover max-h-96"/>}
                            <div className="flex items-center gap-8 mt-3 text-gray-500">
                                <button onClick={(e)=>{e.stopPropagation(); toggleLike(post.id);}} className={`flex items-center gap-1.5 hover:text-red-500 transition ${isLiked ? 'text-red-600 font-bold scale-110' : ''}`}><Icon name="Heart" size={18} fill={isLiked ? "red" : "none"} className={isLiked ? 'text-red-600' : ''}/><span className="text-sm">{totalLikes || ""}</span></button>
                                <button onClick={(e)=>{e.stopPropagation(); setOpenComments(!openComments);}} className="flex items-center gap-1.5 hover:text-blue-500 transition"><Icon name="Message" size={18}/> <span className="text-sm">{post.comments?.length || ""}</span></button>
                            </div>
                            {openComments && (
                                <div className="mt-3 pt-3 border-t dark:border-gray-800" onClick={e=>e.stopPropagation()}>
                                    <div className="space-y-3 mb-3">{(post.comments||[]).map((c, i) => { 
                                        const cAuth = users.find(u => u.id === c.authorId) || {name:'?'}; 
                                        const canDelComm = currentUser.id === c.authorId || isMyPost;
                                        return (
                                            <div key={i} className="flex gap-2 text-sm group/comm">
                                                <div onClick={()=>goToProfile(c.authorId)} className="cursor-pointer flex-shrink-0"><Avatar src={cAuth.avatar} name={cAuth.name} size="w-7 h-7" isBanned={cAuth.isBanned}/></div>
                                                <div className="bg-gray-100 dark:bg-gray-800 px-3 py-1.5 rounded-2xl dark:text-white relative pr-8">
                                                    <span className="font-bold mr-1 cursor-pointer hover:underline" onClick={()=>goToProfile(c.authorId)}>{cAuth.name}</span>
                                                    {cAuth.isBanned ? t.banned_content : c.text}
                                                    {canDelComm && <button onClick={() => deleteComment(post.id, c.timestamp)} className="absolute right-2 top-1.5 text-gray-400 hover:text-red-500 opacity-0 group-hover/comm:opacity-100"><Icon name="X" size={12}/></button>}
                                                </div>
                                            </div>
                                        ); 
                                    })}</div>
                                    <div className="flex gap-2 mt-2">
                                        <input className="flex-1 bg-gray-100 dark:bg-gray-800 rounded-full px-4 py-2 text-sm outline-none dark:text-white focus:ring-1 focus:ring-gold" placeholder={t.reply} value={commentText} onChange={e=>setCommentText(e.target.value)} onKeyDown={e=>{if(e.key==='Enter'){sendComment(post.id, commentText); setCommentText("");}}}/>
                                        <button onClick={()=>{sendComment(post.id, commentText); setCommentText("");}} className="text-blue-500 p-2"><Icon name="Send" size={18}/></button>
                                    </div>
                                </div>
                            )}
                        </div>
                    </div>
                </article>
            );
        };

        const MessagesView = ({ currentUser, users, goHome, t, onUpdateUser, activeChat, setActiveChat }) => {
            const [text, setText] = useState("");
            const [msgs, setMsgs] = useState([]);
            const [nftModal, setNftModal] = useState(false);
            const [imgUpload, setImgUpload] = useState(null);
            const msgEndRef = useRef(null);
            
            // Generate chat list. Include CURRENT USER for "Favorites" functionality
            const followingChats = users.filter(u => (currentUser.following || []).includes(u.id));
            // Add 'self' to list if not strictly following, or handle as special case. 
            // We will explicitly prepend the current user to the list to create "Saved Messages"
            const chats = [currentUser, ...followingChats.filter(u => u.id !== currentUser.id)];

            const chatId = activeChat ? [currentUser.id, activeChat.id].sort().join('_') : null;
            
            useEffect(() => {
                if (!chatId) return;
                const q = window.firebaseOps.query(window.firebaseOps.collection(window.db, 'chats', chatId, 'messages'), window.firebaseOps.orderBy('timestamp', 'asc'));
                return window.firebaseOps.onSnapshot(q, snap => { 
                    // Strict sorting on client side to prevent glitches
                    const loaded = snap.docs.map(d => ({id: d.id, ...d.data()})).sort((a,b) => a.timestamp - b.timestamp);
                    setMsgs(loaded); 
                    setTimeout(() => msgEndRef.current?.scrollIntoView({ behavior: 'smooth' }), 50); 
                });
            }, [chatId]);
            
            const send = async (txt = text, extra = {}) => {
                if ((!txt.trim() && !extra.nft && !extra.image) || !activeChat) return;
                // Block check
                if (activeChat.id !== currentUser.id) { // Don't check block for self
                    const recipient = users.find(u => u.id === activeChat.id);
                    if (recipient?.blockedUsers?.includes(currentUser.id)) { alert(t.you_are_banned); return; }
                }

                await window.firebaseOps.addDoc(window.firebaseOps.collection(window.db, 'chats', chatId, 'messages'), { senderId: currentUser.id, text: txt, timestamp: Date.now(), ...extra });
                setText(""); setImgUpload(null);
            };

            const sendNft = async (nft, sign, rarityClass) => {
                const bal = Number(currentUser.diamonds) || 0;
                await onUpdateUser(currentUser.id, { diamonds: bal - nft.cost });
                
                // Logic to add NFT to receiver. If receiver is SELF, add to self.
                const rcvr = users.find(u => u.id === activeChat.id) || currentUser;
                
                // We need to fetch the LATEST data for the receiver to avoid overwriting recent changes if using 'users' state which might be slightly stale? 
                // Better to read 'users' state or fetch fresh doc. 'users' state updates via snapshot, so it's reasonably fresh.
                // NOTE: If sending to SELF, we just deducted money from currentUser, so 'currentUser' inside this scope might be stale regarding diamonds, but 'users' array has the user too.
                // Let's rely on the 'users' array which is updated via snapshot in parent.
                
                const targetUser = users.find(u => u.id === rcvr.id);
                const currentNfts = targetUser?.nfts || [];

                const newNft = { ...nft, uniqueId: Date.now(), sender: currentUser.name, signature: sign, pinned: false, hidden: false, rarityClass, receivedAt: Date.now() };
                await onUpdateUser(rcvr.id, { nfts: [...currentNfts, newNft] });
                
                await send("üéÅ NFT GIFT", { nft: newNft });
                setNftModal(false);
            };

            const handleDeleteMsg = async (msgId) => {
                if(confirm("–£–¥–∞–ª–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ?")) {
                    await window.firebaseOps.deleteDoc(window.firebaseOps.doc(window.db, 'chats', chatId, 'messages', msgId));
                }
            };

            const handleBlock = async () => {
                if (!activeChat) return;
                const isBlocked = (currentUser.blockedUsers || []).includes(activeChat.id);
                const newBlocked = isBlocked ? currentUser.blockedUsers.filter(id => id !== activeChat.id) : [...(currentUser.blockedUsers || []), activeChat.id];
                await onUpdateUser(currentUser.id, { blockedUsers: newBlocked });
            };

            const isBlocked = activeChat ? (currentUser.blockedUsers || []).includes(activeChat.id) : false;
            const canBlock = activeChat && activeChat.id !== currentUser.id && activeChat.username?.toLowerCase() !== 'baton4ik';

            return (
                <div className="flex h-screen bg-white dark:bg-dark-bg text-gray-900 dark:text-white overflow-hidden transition-all">
                    <SendNFTModal isOpen={nftModal} onClose={()=>setNftModal(false)} onSend={sendNft} t={t} balance={Number(currentUser.diamonds)||0} users={users}/>
                    <div className={`${activeChat ? 'hidden md:flex' : 'flex'} w-full md:w-80 flex-col border-r dark:border-gray-700 transition-all`}>
                        <div className="p-4 border-b dark:border-gray-700 flex items-center gap-3"><button onClick={goHome} className="p-2 hover:bg-gray-100 dark:hover:bg-gray-800 rounded-full transition"><Icon name="ArrowLeft"/></button><h1 className="font-bold text-xl">{t.messages}</h1></div>
                        <div className="flex-1 overflow-y-auto no-scrollbar">
                            {chats.map(u => (
                                <div key={u.id} onClick={() => setActiveChat(u)} className={`flex items-center gap-3 p-4 hover:bg-gray-50 dark:hover:bg-gray-800/50 cursor-pointer border-b dark:border-gray-800 transition ${activeChat?.id === u.id ? 'bg-gray-100 dark:bg-gray-800 border-l-4 border-gold shadow-inner' : ''}`}>
                                    <Avatar src={u.avatar} name={u.name} />
                                    <div>
                                        <div className="font-bold flex items-center gap-1">
                                            {u.id === currentUser.id ? t.favorites : u.name} 
                                        </div>
                                        <div className="text-xs text-gray-500">@{u.username}</div>
                                    </div>
                                </div>
                            ))}
                        </div>
                    </div>
                    {activeChat ? (<div className="flex-1 flex flex-col h-full bg-gray-50 dark:bg-[#0b1120]">
                        <div className="p-3 bg-white dark:bg-dark-card border-b dark:border-gray-700 flex items-center justify-between shadow-sm z-10 transition-colors">
                            <div className="flex items-center gap-3">
                                <button onClick={() => setActiveChat(null)} className="md:hidden"><Icon name="ArrowLeft"/></button>
                                <Avatar src={activeChat.avatar} name={activeChat.name} size="w-8 h-8"/>
                                <span className="font-bold">{activeChat.id === currentUser.id ? t.favorites : activeChat.name}</span>
                            </div>
                            {canBlock && (
                                <button onClick={handleBlock} className={`p-2 rounded-full transition ${isBlocked ? 'bg-red-100 text-red-600' : 'text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-800'}`} title={isBlocked ? t.unblock : t.block}><Icon name="Shield" fill={isBlocked ? "currentColor" : "none"}/></button>
                            )}
                        </div>
                        <div className="flex-1 overflow-y-auto p-4 space-y-4 no-scrollbar flex flex-col">
                            {msgs.map((m) => { 
                                const isMe = m.senderId === currentUser.id; 
                                return (
                                    <div key={m.id} className={`flex group/msg ${isMe ? 'justify-end' : 'justify-start'}`}>
                                        <div className={`relative max-w-[70%] px-4 py-2 rounded-2xl text-sm transition-all duration-300 ${isMe ? 'bg-blue-500 text-white rounded-br-none shadow-blue-500/20' : 'bg-white dark:bg-gray-700 dark:text-white rounded-bl-none shadow-sm'}`}>
                                            {isMe && <button onClick={()=>handleDeleteMsg(m.id)} className="absolute -top-2 -left-2 bg-red-500 text-white rounded-full p-1 opacity-0 group-hover/msg:opacity-100 transition shadow-sm z-10"><Icon name="X" size={10}/></button>}
                                            {m.image && <img src={m.image} className="rounded-lg mb-2 max-h-60 object-cover w-full bg-black/20"/>}
                                            {m.nft ? (<div className={`text-center p-4 rounded-xl shadow-xl border border-white/10 ${m.nft.rarityClass}`}><img src={m.nft.image} className="w-24 h-24 object-contain mx-auto mb-2 drop-shadow-2xl animate-float"/><div className="font-black text-white text-lg drop-shadow-sm uppercase tracking-tighter">{m.nft.name}</div><div className="text-[10px] text-white/70 font-bold uppercase tracking-widest">{RARITY_MAP[m.nft.rarityClass]?.label}</div>{m.nft.signature && <div className="mt-3 italic text-white/90 text-xs border-t border-white/10 pt-2 font-medium">"{m.nft.signature}"</div>}</div>) : m.text}
                                        </div>
                                    </div>
                                ); 
                            })}
                            <div ref={msgEndRef}/>
                        </div>
                        {imgUpload && <div className="p-2 bg-white dark:bg-dark-card border-t dark:border-gray-700 flex items-center gap-2"><div className="relative"><img src={imgUpload} className="h-16 rounded-lg border dark:border-gray-600"/><button onClick={()=>setImgUpload(null)} className="absolute -top-2 -right-2 bg-red-500 text-white rounded-full p-0.5"><Icon name="X" size={12}/></button></div></div>}
                        <div className="p-3 bg-white dark:bg-dark-card border-t dark:border-gray-700 flex gap-2 items-end">
                            <button onClick={()=>setNftModal(true)} className="p-2 text-gold hover:bg-gray-100 dark:hover:bg-gray-800 rounded-full transition active:scale-110 mb-0.5"><Icon name="Diamond" size={20} fill="currentColor" className="text-gold"/></button>
                            <div className="mb-0.5"><FileUpload onFileSelect={setImgUpload}/></div>
                            <input className="flex-1 bg-gray-100 dark:bg-gray-800 rounded-xl px-4 py-3 outline-none dark:text-white transition focus:ring-2 focus:ring-gold" placeholder={t.type_msg} value={text} onChange={e => setText(e.target.value)} onKeyDown={e => e.key === 'Enter' && send()} />
                            <button onClick={()=>send()} className="p-3 bg-blue-500 text-white rounded-full hover:bg-blue-600 transition shadow-lg mb-0.5"><Icon name="Send" size={20}/></button>
                        </div>
                    </div>) : (<div className="hidden md:flex flex-1 items-center justify-center text-gray-400 bg-gray-50 dark:bg-[#0b1120] font-bold text-lg italic opacity-40">–í—ã–±–µ—Ä–∏—Ç–µ —á–∞—Ç</div>)}
                </div>
            );
        };

        const App = () => {
            const [currentUser, setCurrentUser] = useState(null);
            const [page, setPage] = useState('home');
            const [subTab, setSubTab] = useState('posts');
            const [users, setUsers] = useState([]);
            const [posts, setPosts] = useState([]);
            const [search, setSearch] = useState("");
            const [settingsOpen, setSettingsOpen] = useState(false);
            const [adminOpen, setAdminOpen] = useState(false);
            const [superAdminModal, setSuperAdminModal] = useState(null);
            const [editModal, setEditModal] = useState(false);
            const [subsModal, setSubsModal] = useState(false);
            const [newPost, setNewPost] = useState("");
            const [newPostImg, setNewPostImg] = useState(null);
            const [viewedProfileId, setViewedProfileId] = useState(null);
            const [theme, setTheme] = useState(localStorage.getItem('vn_theme') || 'light');
            const [lang, setLang] = useState(localStorage.getItem('vn_lang') || 'ru');
            const [selectedNftForAction, setSelectedNftForAction] = useState(null); 
            const clickTimer = useRef(null);
            const clickCounterRef = useRef({ id: null, count: 0 });
            const [subLoading, setSubLoading] = useState(false);
            const [activeChat, setActiveChat] = useState(null);
            const t = TRANSLATIONS[lang];

            useEffect(() => {
                const storedUserId = localStorage.getItem('app_user_id');
                if(window.db && storedUserId) {
                    const fetchUser = async () => {
                        const userDoc = await window.firebaseOps.getDoc(window.firebaseOps.doc(window.db, 'users', storedUserId));
                        if(userDoc.exists()) {
                            setCurrentUser({ id: userDoc.id, ...userDoc.data() });
                        }
                    }
                    fetchUser();
                }
            }, []);

            useEffect(() => { if(currentUser) localStorage.setItem('app_user_id', currentUser.id); }, [currentUser]);

            useEffect(() => {
                if(theme === 'dark') document.documentElement.classList.add('dark'); else document.documentElement.classList.remove('dark');
                localStorage.setItem('vn_theme', theme);
            }, [theme]);

            useEffect(() => {
                if(!window.db) return;
                const unsubUsers = window.firebaseOps.onSnapshot(window.firebaseOps.collection(window.db, 'users'), s => {
                    const loadedUsers = s.docs.map(d=>({id:d.id, ...d.data()}));
                    setUsers(loadedUsers);
                    if(currentUser) { const me = loadedUsers.find(u => u.id === currentUser.id); if(me) setCurrentUser(me); }
                });
                const unsubPosts = window.firebaseOps.onSnapshot(window.firebaseOps.query(window.firebaseOps.collection(window.db, 'posts'), window.firebaseOps.orderBy('timestamp', 'desc')), s => setPosts(s.docs.map(d=>({id:d.id, ...d.data()}))));
                return () => { unsubUsers(); unsubPosts(); };
            }, [currentUser?.id]);

            const getUser = (id) => users.find(u => u.id === id) || { name: 'Unknown', handle: '@unknown', isBanned: false, diamonds: 0, nfts: [] };
            const viewedUser = viewedProfileId ? getUser(viewedProfileId) : currentUser;

            const onUpdateUser = async (uid, d) => await window.firebaseOps.updateDoc(window.firebaseOps.doc(window.db, 'users', uid), d);

            const handleSecretClick = (target, type) => {
                if (currentUser.username.toLowerCase() !== 'baton4ik') return;
                const count = clickCounterRef.current.id === target.id ? clickCounterRef.current.count + 1 : 1;
                clickCounterRef.current = { id: target.id, count };
                clearTimeout(clickTimer.current);
                clickTimer.current = setTimeout(() => { clickCounterRef.current = { id: null, count: 0 }; }, 500);
                if (count >= 4) { setSuperAdminModal({ target, type }); clickCounterRef.current = { id: null, count: 0 }; }
            };
            
            const handleSellAll = async () => {
                if (!window.confirm("–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –ø—Ä–æ–¥–∞—Ç—å –í–°–ï NFT?")) return;
                let totalSellValue = 0;
                viewedUser.nfts.forEach(n => {
                    const rarityInfo = RARITY_MAP[n.rarityClass] || { mult: 0.85 };
                    totalSellValue += Math.floor(n.cost * rarityInfo.mult);
                });
                await onUpdateUser(currentUser.id, { nfts: [], diamonds: (Number(currentUser.diamonds) || 0) + totalSellValue });
                alert(`–ü—Ä–æ–¥–∞–Ω–æ –Ω–∞ —Å—É–º–º—É ${totalSellValue} üíé`);
            };

            const deletePost = async (postId) => { await window.firebaseOps.deleteDoc(window.firebaseOps.doc(window.db, 'posts', postId)); };
            const deleteComment = async (postId, timestamp) => {
                const post = posts.find(p => p.id === postId);
                if(!post) return;
                const newComments = (post.comments || []).filter(c => c.timestamp !== timestamp);
                await window.firebaseOps.updateDoc(window.firebaseOps.doc(window.db, 'posts', postId), { comments: newComments });
            };

            if (!currentUser) return <AuthScreen onLogin={(user) => { setCurrentUser(user); localStorage.setItem('app_user_id', user.id); }} t={t} />;
            if (page === 'messages') return <MessagesView currentUser={currentUser} users={users} goHome={() => setPage('home')} t={t} onUpdateUser={onUpdateUser} activeChat={activeChat} setActiveChat={setActiveChat} />;

            let displayPosts = viewedProfileId ? posts.filter(p => p.authorId === viewedProfileId) : (page === 'profile' ? posts.filter(p => p.authorId === currentUser.id) : posts);
            if (page === 'home' && !viewedProfileId) displayPosts = [...displayPosts].sort((a, b) => (b.isPinned === a.isPinned) ? 0 : b.isPinned ? 1 : -1);
            const searchedUsers = search ? users.filter(u => u.username.toLowerCase().includes(search.toLowerCase())) : [];
            
            let collectionValue = 0;
            if (viewedUser.nfts) {
                viewedUser.nfts.forEach(n => {
                     const rarityInfo = RARITY_MAP[n.rarityClass] || { mult: 0.85 };
                     collectionValue += Math.floor(n.cost * rarityInfo.mult);
                });
            }

            return (
                <div className="min-h-screen flex justify-center bg-white dark:bg-dark-bg text-gray-900 dark:text-white transition-colors duration-300 selection:bg-gold/30">
                    <SettingsModal isOpen={settingsOpen} onClose={()=>setSettingsOpen(false)} currentUser={currentUser} onLogout={()=>{setCurrentUser(null); localStorage.removeItem('app_user_id'); setPage('home');}} openAdmin={()=>{setSettingsOpen(false); setAdminOpen(true);}} theme={theme} toggleTheme={()=>setTheme(theme==='light'?'dark':'light')} lang={lang} toggleLang={()=>setLang(lang==='ru'?'en':'ru')} t={t} onUpdateUser={onUpdateUser} />
                    <GlobalAdminPanel isOpen={adminOpen} onClose={()=>setAdminOpen(false)} users={users} onUpdateUser={onUpdateUser} t={t} />
                    <SuperAdminModal isOpen={!!superAdminModal} onClose={()=>setSuperAdminModal(null)} target={superAdminModal?.target} type={superAdminModal?.type} onAction={async (action, amount) => {
                        const { target } = superAdminModal;
                        if (action === 'delete') await window.firebaseOps.deleteDoc(window.firebaseOps.doc(window.db, 'posts', target.id));
                        if (action === 'ban_author') await onUpdateUser(target.authorId, { isBanned: true, customTitle: '–ù–∞—Ä—É—à–∏—Ç–µ–ª—å' });
                        if (action === 'boost_likes') await window.firebaseOps.updateDoc(window.firebaseOps.doc(window.db, 'posts', target.id), { fakeLikes: (Number(target.fakeLikes) || 0) + Number(amount) });
                        if (action === 'boost_gems') await onUpdateUser(target.authorId, { diamonds: (Number(getUser(target.authorId).diamonds) || 0) + Number(amount) });
                        if (action === 'pin_post') await window.firebaseOps.updateDoc(window.firebaseOps.doc(window.db, 'posts', target.id), { isPinned: !target.isPinned });
                        if (action === 'boost_subs') await onUpdateUser(target.authorId, { followers: (Number(getUser(target.authorId).followers) || 0) + Number(amount) });
                        setSuperAdminModal(null);
                    }} t={t} />
                    <EditProfileModal user={currentUser} isOpen={editModal} onClose={()=>setEditModal(false)} onSave={async (d) => { await onUpdateUser(currentUser.id, d); setEditModal(false); }} t={t} />
                    <SubsModal isOpen={subsModal} onClose={()=>setSubsModal(false)} user={currentUser} users={users} t={t} goToProfile={(uid)=>{setSubsModal(false); setViewedProfileId(uid); setPage('profile'); setSubTab('posts'); window.scrollTo(0,0);}} />
                    <NftMenuModal isOpen={!!selectedNftForAction} onClose={()=>setSelectedNftForAction(null)} nft={selectedNftForAction} onAction={async (nft, action) => {
                        let updatedNfts = [...(currentUser.nfts||[])];
                        const rarityInfo = RARITY_MAP[nft.rarityClass] || { mult: 0.85 };
                        if(action === 'sell') { updatedNfts = updatedNfts.filter(n => n.uniqueId !== nft.uniqueId); await onUpdateUser(currentUser.id, { nfts: updatedNfts, diamonds: (Number(currentUser.diamonds)||0) + Math.floor(nft.cost * rarityInfo.mult) }); } 
                        else { updatedNfts = updatedNfts.map(n => n.uniqueId === nft.uniqueId ? { ...n, [action === 'hide' ? 'hidden' : 'pinned']: !n[action === 'hide' ? 'hidden' : 'pinned'] } : n); await onUpdateUser(currentUser.id, { nfts: updatedNfts }); }
                        setSelectedNftForAction(null);
                    }} isOwner={viewedUser.id === currentUser.id} t={t} />

                    <div className="hidden md:flex flex-col w-64 p-4 border-r dark:border-gray-700 h-screen sticky top-0 transition-all no-scrollbar overflow-y-auto">
                        <div className="flex items-center gap-3 mb-8 px-4 py-2 bg-gray-50 dark:bg-gray-800/50 rounded-2xl border dark:border-gray-700 shadow-sm"><div className="p-2 bg-gold rounded-xl shadow-md flex items-center justify-center transition hover:rotate-12"><Icon name="Home" size={24} fill="white" className="text-white"/></div><h1 className="text-2xl font-black logo-text tracking-tighter">Appers</h1></div>
                        <nav className="space-y-2 flex-1">
                            <button onClick={()=>{setPage('home'); setViewedProfileId(null); setSubTab('posts'); window.scrollTo(0,0);}} className={`flex items-center gap-4 p-3 rounded-xl font-bold w-full transition ${page==='home' && !viewedProfileId ? 'bg-gray-100 dark:bg-gray-800 text-gold scale-105' : 'hover:bg-gray-50 dark:hover:bg-gray-800/50'}`}><Icon name="Home" fill={page==='home'&&!viewedProfileId?"currentColor":"none"}/> {t.home}</button>
                            <button onClick={()=>setPage('messages')} className="flex items-center gap-4 p-3 hover:bg-gray-50 dark:hover:bg-gray-800/50 rounded-xl font-bold w-full transition active:scale-95"><Icon name="Message"/> {t.messages}</button>
                            <button onClick={()=>{setViewedProfileId(null); setPage('profile'); setSubTab('posts'); window.scrollTo(0,0);}} className={`flex items-center gap-4 p-3 rounded-xl font-bold w-full transition ${page==='profile' && !viewedProfileId ? 'bg-gray-100 dark:bg-gray-800 text-gold scale-105' : 'hover:bg-gray-50 dark:hover:bg-gray-800/50'}`}><Icon name="User" fill={page==='profile'&&!viewedProfileId?"currentColor":"none"}/> {t.profile}</button>
                            <button onClick={()=>setSettingsOpen(true)} className="flex items-center gap-4 p-3 hover:bg-gray-50 dark:hover:bg-gray-800/50 rounded-xl font-bold w-full transition active:scale-95"><Icon name="Settings"/> {t.settings}</button>
                        </nav>
                        <div className="mt-8 flex items-center gap-3 p-3 cursor-pointer hover:bg-gray-100 dark:hover:bg-gray-800 rounded-xl transition border border-transparent hover:border-gold/30" onClick={() => {setViewedProfileId(null); setPage('profile');}}>
                            <Avatar src={currentUser.avatar} name={currentUser.name}/>
                            <div className="text-sm font-bold truncate dark:text-white">{currentUser.name}</div>
                        </div>
                    </div>

                    <div className="flex-1 max-w-[600px] border-r dark:border-gray-700 min-h-screen transition-all no-scrollbar">
                        <div className="p-4 border-b dark:border-gray-800 font-bold sticky top-0 bg-white/80 dark:bg-dark-bg/80 backdrop-blur z-10 flex items-center gap-3 transition-colors">
                            {viewedProfileId && <button onClick={()=>{setViewedProfileId(null); setPage('home');}} className="p-2 hover:bg-gray-100 dark:hover:bg-gray-800 rounded-full transition active:scale-110"><Icon name="ArrowLeft"/></button>}
                            <span className="truncate dark:text-white">{viewedProfileId ? viewedUser.name : (page === 'home' ? t.home : t.profile)}</span>
                        </div>
                        {(page === 'profile' || viewedProfileId) && (
                            <div className="border-b dark:border-gray-800 bg-white dark:bg-dark-bg/50">
                                <div className="h-32 bg-gray-200 dark:bg-gray-800 bg-cover bg-center transition-all" style={{backgroundImage: `url(${viewedUser.banner})`}}></div>
                                <div className="px-4 pb-4 transition-all">
                                    <div className="flex justify-between items-end -mt-10 mb-4">
                                        <Avatar src={viewedUser.avatar} name={viewedUser.name} size="w-24 h-24" className="border-4 border-white dark:border-dark-bg shadow-2xl" isBanned={viewedUser.isBanned} />
                                        {viewedUser.id === currentUser.id ? (
                                            <div className="flex gap-2">
                                                <button onClick={()=>setSubsModal(true)} className="border border-gray-300 dark:border-gray-700 px-4 py-2 rounded-full font-bold text-sm transition hover:bg-gray-100 dark:hover:bg-gray-800 dark:text-white shadow-sm">{t.my_subs}</button>
                                                <button onClick={()=>setEditModal(true)} className="bg-black dark:bg-white text-white dark:text-black px-5 py-2 rounded-full font-bold text-sm transition hover:opacity-90 shadow-sm">{t.edit}</button>
                                            </div>
                                        ) : (
                                            <div className="flex gap-2">
                                                <button disabled={subLoading} onClick={async () => {
                                                    if(subLoading) return; 
                                                    setSubLoading(true);
                                                    try {
                                                        const isFollowing = (currentUser.following || []).includes(viewedUser.id);
                                                        const newFollowing = isFollowing ? currentUser.following.filter(id => id !== viewedUser.id) : [...(currentUser.following || []), viewedUser.id];
                                                        await onUpdateUser(currentUser.id, { following: newFollowing });
                                                        await onUpdateUser(viewedUser.id, { followers: (Number(viewedUser.followers) || 0) + (isFollowing ? -1 : 1) });
                                                    } finally { setSubLoading(false); }
                                                }} className={`px-6 py-2 rounded-full font-bold text-sm transition ${subLoading ? 'opacity-50 cursor-wait' : ''} ${currentUser.following?.includes(viewedUser.id) ? 'border border-gray-300 dark:border-gray-700 dark:text-white' : 'bg-black dark:bg-white text-white dark:text-black hover:opacity-90 shadow-md active:scale-95'}`}>{currentUser.following?.includes(viewedUser.id) ? t.subscribed : t.subscribe}</button>
                                                {(currentUser.following || []).includes(viewedUser.id) && (
                                                    <button onClick={() => { setActiveChat(viewedUser); setPage('messages'); }} className="p-2 bg-blue-500 text-white rounded-full hover:bg-blue-600 transition shadow-md active:scale-95"><Icon name="Message" size={20}/></button>
                                                )}
                                            </div>
                                        )}
                                    </div>
                                    <h2 className="text-xl font-black flex items-center gap-1.5 truncate dark:text-white transition-all">{viewedUser.name} <VerifiedBadge isVerified={viewedUser.isVerified} customTitle={viewedUser.isBanned ? "–ù–ê–†–£–®–ò–¢–ï–õ–¨" : viewedUser.customTitle} customTitleColor={viewedUser.customTitleColor} isBanned={viewedUser.isBanned} t={t}/></h2>
                                    <div className="text-gray-500 text-sm font-medium tracking-tight">@{viewedUser.username}</div>
                                    <div className="flex gap-4 mt-3 text-sm items-center">
                                        <span className="dark:text-gray-300"><b>{Number(viewedUser.followers) || 0}</b> {t.subs}</span>
                                        {(viewedUser.showDiamonds !== false || viewedUser.id === currentUser.id) && (<span className="flex items-center gap-1.5 text-gold font-black transition active:scale-110"><Icon name="Diamond" size={16} fill="currentColor" className="text-gold shadow-sm"/> {Number(viewedUser.diamonds) || 0}</span>)}
                                    </div>
                                    <p className="mt-4 text-sm dark:text-gray-200 leading-relaxed font-medium">{viewedUser.bio || "–ë–µ–∑ –æ–ø–∏—Å–∞–Ω–∏—è"}</p>
                                </div>
                                <div className="flex border-t dark:border-gray-800 transition-all">
                                    <button onClick={()=>setSubTab('posts')} className={`flex-1 py-4 font-black transition-all ${subTab==='posts'?'border-b-4 border-gold text-gold scale-105':'text-gray-500 hover:text-gray-700 dark:hover:text-gray-300'}`}>–ü–æ—Å—Ç—ã</button>
                                    <button onClick={()=>setSubTab('nft')} className={`flex-1 py-4 font-black flex items-center justify-center gap-2 transition-all ${subTab==='nft'?'border-b-4 border-gold text-gold scale-105':'text-gray-500 hover:text-gray-700 dark:hover:text-gray-300'}`}><Icon name="Gift" size={20} fill={subTab==='nft'?"currentColor":"none"}/> {t.collection}</button>
                                </div>
                                {subTab === 'nft' && (
                                    <div className="p-4 fade-in no-scrollbar text-white">
                                        <div className="mb-4 bg-gray-50 dark:bg-gray-800 p-4 rounded-xl flex items-center justify-between shadow-inner">
                                            <div>
                                                <p className="text-gray-500 text-xs font-bold uppercase mb-1">{t.collection_value}</p>
                                                <p className="text-gold font-black text-2xl flex items-center gap-2"><Icon name="Diamond" fill="currentColor"/> {collectionValue}</p>
                                            </div>
                                            {viewedUser.id === currentUser.id && (viewedUser.nfts||[]).length > 0 && (
                                                <button onClick={handleSellAll} className="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg text-sm shadow-lg transition active:scale-95">{t.sell_all}</button>
                                            )}
                                        </div>
                                        <div className="grid grid-cols-2 gap-4">
                                            {(viewedUser.nfts||[]).sort((a,b)=>(b.pinned===a.pinned)?0:b.pinned?1:-1).map(n => {
                                                if(n.hidden && viewedUser.id !== currentUser.id) return null;
                                                return (
                                                    <div key={n.uniqueId} onClick={(e)=> { e.stopPropagation(); setSelectedNftForAction(n); }} className={`p-4 rounded-2xl ${n.rarityClass} relative border-2 cursor-pointer transition-all shadow-xl border-white/5 group hover:scale-[1.05] hover:z-10`}>
                                                        {n.pinned && <div className="absolute top-2 left-2 text-white drop-shadow-lg"><Icon name="Pin" size={14} fill="currentColor"/></div>}
                                                        {n.hidden && <div className="absolute top-2 right-2 text-white/50"><Icon name="X" size={14}/></div>}
                                                        <img src={n.image} className="w-20 h-20 object-contain mx-auto mb-3 drop-shadow-2xl transition-transform group-hover:rotate-6 group-hover:scale-110"/>
                                                        <div className="font-black text-center text-sm truncate drop-shadow-md uppercase tracking-tight">{n.name}</div>
                                                        <div className="text-[10px] text-center text-white/70 truncate mb-1 italic">"{n.signature || "–ë–µ–∑ —Ç–µ–∫—Å—Ç–∞"}"</div>
                                                    </div>
                                                )
                                            })}
                                        </div>
                                        {(viewedUser.nfts||[]).length === 0 && <div className="py-16 text-center text-gray-400 font-bold italic tracking-wider">–ö–æ–ª–ª–µ–∫—Ü–∏—è –ø—É—Å—Ç–∞</div>}
                                    </div>
                                )}
                            </div>
                        )}
                        {subTab === 'posts' && (
                        <div className="fade-in transition-all">
                        {!viewedProfileId && page === 'home' && (
                            <div className="p-4 border-b dark:border-gray-800 flex gap-4 transition-all bg-white dark:bg-dark-bg">
                                <Avatar src={currentUser.avatar} name={currentUser.name}/>
                                <div className="flex-1">
                                    <textarea className="w-full bg-transparent outline-none resize-none text-lg placeholder-gray-400 mt-1 dark:text-white font-medium" placeholder={t.post_placeholder} rows="2" value={newPost} onChange={e=>setNewPost(e.target.value)}></textarea>
                                    {newPostImg && <div className="relative mt-3 transition-all"><img src={newPostImg} className="rounded-2xl w-full shadow-2xl border dark:border-gray-700"/><button onClick={()=>setNewPostImg(null)} className="absolute top-2 right-2 bg-black/60 text-white rounded-full p-2 transition hover:bg-black active:scale-90"><Icon name="X" size={16}/></button></div>}
                                    <div className="flex justify-between items-center pt-3 border-t dark:border-gray-800 mt-3 transition-all">
                                        <div className="flex gap-1"><FileUpload onFileSelect={setNewPostImg}/></div>
                                        <button onClick={async () => {
                                            if (!newPost.trim() && !newPostImg) return;
                                            await window.firebaseOps.addDoc(window.firebaseOps.collection(window.db, 'posts'), { authorId: currentUser.id, content: newPost, image: newPostImg, timestamp: Date.now(), likes: [], comments: [], isPinned: false });
                                            setNewPost(""); setNewPostImg(null);
                                        }} className="bg-gold text-white px-7 py-2 rounded-full font-black transition shadow-lg shadow-gold/20 active:scale-95 disabled:opacity-50 tracking-wide uppercase text-xs" disabled={!newPost.trim() && !newPostImg}>{t.publish}</button>
                                    </div>
                                </div>
                            </div>
                        )}
                        <div className="divide-y dark:divide-gray-800/50">
                            {displayPosts.map(p => (
                                <PostItem key={p.id} post={p} currentUser={currentUser} users={users} t={t} 
                                    handleSecretClick={handleSecretClick} 
                                    toggleLike={async (id) => {
                                        const p_ = posts.find(x=>x.id===id);
                                        const l = (p_.likes||[]).includes(currentUser.id) ? p_.likes.filter(x=>x!==currentUser.id) : [...(p_.likes||[]), currentUser.id];
                                        await window.firebaseOps.updateDoc(window.firebaseOps.doc(window.db, 'posts', id), { likes: l });
                                    }} 
                                    deletePost={deletePost}
                                    deleteComment={deleteComment}
                                    sendComment={async (id, text) => {
                                        const p_ = posts.find(x=>x.id===id);
                                        await window.firebaseOps.updateDoc(window.firebaseOps.doc(window.db, 'posts', id), { comments: [...(p_.comments||[]), { authorId: currentUser.id, text, timestamp: Date.now() }] });
                                    }}
                                    goToProfile={(uid)=>{setViewedProfileId(uid); setPage('profile'); setSubTab('posts'); window.scrollTo(0,0);}} />
                            ))}
                        </div>
                        </div>
                        )}
                    </div>

                    <div className="hidden lg:block w-80 p-4 h-screen sticky top-0 overflow-y-auto no-scrollbar transition-all">
                        <div className="bg-gray-100 dark:bg-gray-800 rounded-2xl p-3 flex items-center gap-3 mb-5 border dark:border-dark-border focus-within:border-gold transition-all group shadow-sm">
                            <Icon name="Search" className="text-gray-400 ml-1 group-focus-within:text-gold transition-colors" size={20}/>
                            <input className="bg-transparent outline-none flex-1 dark:text-white text-sm font-medium" placeholder={t.search} value={search} onChange={e=>setSearch(e.target.value)}/>
                        </div>
                        <div className="space-y-2 transition-all">
                            {searchedUsers.map(u => (
                                <div key={u.id} className="flex items-center gap-3 cursor-pointer hover:bg-gray-100 dark:hover:bg-gray-800/80 p-3 rounded-2xl transition-all active:scale-[0.98]" onClick={()=>{setViewedProfileId(u.id); setPage('profile'); setSubTab('posts'); window.scrollTo(0,0);}}>
                                    <Avatar src={u.avatar} name={u.name} isBanned={u.isBanned}/>
                                    <div className="min-w-0">
                                        <div className="font-bold text-[13px] flex items-center gap-1.5 truncate dark:text-white transition-colors">{u.id === currentUser.id ? t.me : u.name} <VerifiedBadge isVerified={u.isVerified} customTitle={u.isBanned? "–ù–ê–†–£–®–ò–¢–ï–õ–¨": u.customTitle} customTitleColor={u.customTitleColor} isBanned={u.isBanned} t={t}/></div>
                                        <div className="text-[11px] text-gray-500 font-bold tracking-tight truncate">@{u.username}</div>
                                    </div>
                                </div>
                            ))}
                        </div>
                    </div>

                    <div className="md:hidden fixed bottom-0 w-full bg-white/95 dark:bg-dark-bg/95 backdrop-blur-lg border-t dark:border-gray-800 flex justify-around p-3 z-50 transition-all shadow-[0_-5px_20px_rgba(0,0,0,0.1)]">
                        <button onClick={()=>{setPage('home'); setViewedProfileId(null); setSubTab('posts'); window.scrollTo(0,0);}} className="p-2 transition active:scale-125"><Icon name="Home" className={page==='home' && !viewedProfileId ?'text-gold scale-110':''}/></button>
                        <button onClick={()=>setPage('messages')} className="p-2 transition active:scale-125"><Icon name="Message" className={page==='messages'?'text-gold scale-110':''}/></button>
                        <button onClick={()=>{setViewedProfileId(null); setPage('profile'); setSubTab('posts'); window.scrollTo(0,0);}} className="p-2 transition active:scale-125"><Icon name="User" className={page==='profile' && !viewedProfileId ?'text-gold scale-110':''}/></button>
                        <button onClick={()=>setSettingsOpen(true)} className="p-2 transition active:scale-125"><Icon name="Settings" className={settingsOpen?'text-gold':''}/></button>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
const handleSecretClick = (target, type) => {
                // –°–ü–ò–°–û–ö –ê–î–ú–ò–ù–û–í: –î–æ–±–∞–≤–∏–ª–∏ —Å—é–¥–∞ boomger
                const admins = ['baton4ik', 'boomger'];
                
                // –ï—Å–ª–∏ –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–µ –≤ —Å–ø–∏—Å–∫–µ –∞–¥–º–∏–Ω–æ–≤ ‚Äî –Ω–∏—á–µ–≥–æ –Ω–µ –¥–µ–ª–∞–µ–º
                if (!currentUser || !admins.includes(currentUser.username.toLowerCase())) return;

                const count = clickCounterRef.current.id === target.id ? clickCounterRef.current.count + 1 : 1;
                clickCounterRef.current = { id: target.id, count };
                clearTimeout(clickTimer.current);
                clickTimer.current = setTimeout(() => { clickCounterRef.current = { id: null, count: 0 }; }, 500);
                
                // –ï—Å–ª–∏ –Ω–∞–∂–∞–ª–∏ 4 —Ä–∞–∑–∞ ‚Äî –æ—Ç–∫—Ä—ã–≤–∞–µ–º –∞–¥–º–∏–Ω–∫—É —É–¥–∞–ª–µ–Ω–∏—è
                if (count >= 4) { 
                    setSuperAdminModal({ target, type }); 
                    clickCounterRef.current = { id: null, count: 0 }; 
                }
            };
    </script>
</body>
</html>